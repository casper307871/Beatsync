name: Build, Push & Deploy to Azure App Service

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: yourregistry.azurecr.io       # ğŸ‘ˆ replace with your ACR login server
  IMAGE: your-image-name                  # ğŸ‘ˆ example: weather-modification-bot
  TAG: latest
  APP_SERVICE_NAME: your-app-service      # ğŸ‘ˆ your Azure App Service name
  RESOURCE_GROUP: your-resource-group     # ğŸ‘ˆ your Azure resource group

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies (safe mode)
        run: |
          if [ -f package-lock.json ]; then
            echo "âœ… Lock file found, running npm ci..."
            npm ci
          else
            echo "âš ï¸ No lock file found, running npm install..."
            npm install
            echo "ğŸª„ Creating package-lock.json for next builds..."
            npm i --package-lock-only
          fi

      - name: ğŸ” Log in to Azure Container Registry
        run: echo "${{ secrets.ACR_PASSWORD }}" | docker login $REGISTRY -u ${{ secrets.ACR_USERNAME }} --password-stdin

      - name: ğŸ” Find Dockerfile
        id: dockerfile
        run: |
          DOCKERFILE_PATH=$(find . -type f -iname "Dockerfile" | head -n 1)
          if [ -z "$DOCKERFILE_PATH" ]; then
            echo "âŒ No Dockerfile found!"
            exit 1
          fi
          echo "âœ… Found Dockerfile at: $DOCKERFILE_PATH"
          echo "path=$DOCKERFILE_PATH" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build Docker image
        run: |
          docker build -f "${{ steps.dockerfile.outputs.path }}" -t "$REGISTRY/$IMAGE:$TAG" .

      - name: ğŸš€ Push image to ACR
        run: docker push "$REGISTRY/$IMAGE:$TAG"

      - name: ğŸ”“ Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ§© Deploy container to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_SERVICE_NAME }}
          images: ${{ env.REGISTRY }}/${{ env.IMAGE }}:${{ env.TAG }}

      - name: ğŸ”’ Cleanup
        run: |
          docker logout $REGISTRY
          az logout
